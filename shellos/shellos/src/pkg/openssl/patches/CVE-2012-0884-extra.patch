Origin: http://cvs.openssl.org/chngview?cn=22537
  and http://cvs.openssl.org/chngview?cn=22564
Subject: initialise tkeylen properly

  Initialise tkeylen properly when encrypting CMS messages.
  Thanks to Solar Designer of Openwall for reporting this issue.
  [Steve Henson]

---
 crypto/cms/cms_enc.c |    6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

Index: b/crypto/cms/cms_enc.c
===================================================================
--- a/crypto/cms/cms_enc.c
+++ b/crypto/cms/cms_enc.c
@@ -74,7 +74,7 @@ BIO *cms_EncryptedContent_init_bio(CMS_E
 	X509_ALGOR *calg = ec->contentEncryptionAlgorithm;
 	unsigned char iv[EVP_MAX_IV_LENGTH], *piv = NULL;
 	unsigned char *tkey = NULL;
-	size_t tkeylen;
+	size_t tkeylen = 0;
 
 	int ok = 0;
 
@@ -139,10 +139,10 @@ BIO *cms_EncryptedContent_init_bio(CMS_E
 				CMS_R_CIPHER_PARAMETER_INITIALISATION_ERROR);
 		goto err;
 		}
+	tkeylen = EVP_CIPHER_CTX_key_length(ctx);
 	/* Generate random session key */
 	if (!enc || !ec->key)
 		{
-		tkeylen = EVP_CIPHER_CTX_key_length(ctx);
 		tkey = OPENSSL_malloc(tkeylen);
 		if (!tkey)
 			{
@@ -174,7 +174,7 @@ BIO *cms_EncryptedContent_init_bio(CMS_E
 			/* Only reveal failure if debugging so we don't
 			 * leak information which may be useful in MMA.
 			 */
-			if (ec->debug)
+			if (enc || ec->debug)
 				{
 				CMSerr(CMS_F_CMS_ENCRYPTEDCONTENT_INIT_BIO,
 						CMS_R_INVALID_KEY_LENGTH);
